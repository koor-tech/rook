<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Rook Ceph Documentation"><meta name=author content="Rook Authors"><link href=https://rook.io/1.8/ceph-monitoring/ rel=canonical><link rel=icon href=https://rook.io/images/favicon_192x192.png><meta name=generator content="mkdocs-1.3.0, mkdocs-material-8.2.5+insiders-4.11.0"><title>Prometheus Monitoring - Rook Ceph Documentation</title><link rel=stylesheet href=../assets/stylesheets/main.589a02ac.min.css><link rel=stylesheet href=../assets/stylesheets/palette.e6a45f82.min.css><link rel=stylesheet href=../stylesheets/extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=rook-blue data-md-color-accent=deep-orange> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#prometheus-monitoring class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-component=outdated hidden> <aside class="md-banner md-banner--warning"> <div class="md-banner__inner md-grid md-typeset"> You're not viewing the latest version. <a href=../..> <strong>Click here to go to latest.</strong> </a> </div> <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="Rook Ceph Documentation" class="md-header__button md-logo" aria-label="Rook Ceph Documentation" data-md-component=logo> <img src=https://rook.io/images/rook-logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Rook Ceph Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Prometheus Monitoring </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=rook-blue data-md-color-accent=deep-orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=rook-blue data-md-color-accent=red aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/rook/rook title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Rook Ceph Documentation" class="md-nav__button md-logo" aria-label="Rook Ceph Documentation" data-md-component=logo> <img src=https://rook.io/images/rook-logo.svg alt=logo> </a> Rook Ceph Documentation </label> <div class=md-nav__source> <a href=https://github.com/rook/rook title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Rook </span> </a> </li> <li class=md-nav__item> <a href=../async-disaster-recovery/ class=md-nav__link> <span class=md-ellipsis> Failover and Failback </span> </a> </li> <li class=md-nav__item> <a href=../authenticated-registry/ class=md-nav__link> <span class=md-ellipsis> Authenticated Registries </span> </a> </li> <li class=md-nav__item> <a href=../ceph-advanced-configuration/ class=md-nav__link> <span class=md-ellipsis> Advanced Configuration </span> </a> </li> <li class=md-nav__item> <a href=../ceph-block/ class=md-nav__link> <span class=md-ellipsis> Block Storage </span> </a> </li> <li class=md-nav__item> <a href=../ceph-client-crd/ class=md-nav__link> <span class=md-ellipsis> Client CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-cluster-crd/ class=md-nav__link> <span class=md-ellipsis> Cluster CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-common-issues/ class=md-nav__link> <span class=md-ellipsis> Common Issues </span> </a> </li> <li class=md-nav__item> <a href=../ceph-configuration/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../ceph-csi-drivers/ class=md-nav__link> <span class=md-ellipsis> Ceph CSI </span> </a> </li> <li class=md-nav__item> <a href=../ceph-csi-snapshot/ class=md-nav__link> <span class=md-ellipsis> Snapshots </span> </a> </li> <li class=md-nav__item> <a href=../ceph-csi-troubleshooting/ class=md-nav__link> <span class=md-ellipsis> CSI Common Issues </span> </a> </li> <li class=md-nav__item> <a href=../ceph-csi-volume-clone/ class=md-nav__link> <span class=md-ellipsis> Volume clone </span> </a> </li> <li class=md-nav__item> <a href=../ceph-dashboard/ class=md-nav__link> <span class=md-ellipsis> Ceph Dashboard </span> </a> </li> <li class=md-nav__item> <a href=../ceph-disaster-recovery/ class=md-nav__link> <span class=md-ellipsis> Disaster Recovery </span> </a> </li> <li class=md-nav__item> <a href=../ceph-examples/ class=md-nav__link> <span class=md-ellipsis> Examples </span> </a> </li> <li class=md-nav__item> <a href=../ceph-filesystem-crd/ class=md-nav__link> <span class=md-ellipsis> Shared Filesystem CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-filesystem/ class=md-nav__link> <span class=md-ellipsis> Shared Filesystem </span> </a> </li> <li class=md-nav__item> <a href=../ceph-fs-mirror-crd/ class=md-nav__link> <span class=md-ellipsis> Filesystem Mirror CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-fs-subvolumegroup/ class=md-nav__link> <span class=md-ellipsis> SubVolume Group CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-kms/ class=md-nav__link> <span class=md-ellipsis> Key Management System </span> </a> </li> <li class=md-nav__item> <a href=../ceph-mon-health/ class=md-nav__link> <span class=md-ellipsis> Monitor Health </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Prometheus Monitoring </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Prometheus Monitoring </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#prometheus-operator class=md-nav__link> Prometheus Operator </a> </li> <li class=md-nav__item> <a href=#prometheus-instances class=md-nav__link> Prometheus Instances </a> </li> <li class=md-nav__item> <a href=#prometheus-web-console class=md-nav__link> Prometheus Web Console </a> </li> <li class=md-nav__item> <a href=#prometheus-consoles class=md-nav__link> Prometheus Consoles </a> </li> <li class=md-nav__item> <a href=#prometheus-alerts class=md-nav__link> Prometheus Alerts </a> <nav class=md-nav aria-label="Prometheus Alerts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#customize-alerts class=md-nav__link> Customize Alerts </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#grafana-dashboards class=md-nav__link> Grafana Dashboards </a> </li> <li class=md-nav__item> <a href=#updates-and-upgrades class=md-nav__link> Updates and Upgrades </a> </li> <li class=md-nav__item> <a href=#teardown class=md-nav__link> Teardown </a> </li> <li class=md-nav__item> <a href=#special-cases class=md-nav__link> Special Cases </a> <nav class=md-nav aria-label="Special Cases"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tectonic-bare-metal class=md-nav__link> Tectonic Bare Metal </a> </li> <li class=md-nav__item> <a href=#csi-liveness class=md-nav__link> CSI Liveness </a> </li> <li class=md-nav__item> <a href=#collecting-rbd-per-image-io-statistics class=md-nav__link> Collecting RBD per-image IO statistics </a> </li> <li class=md-nav__item> <a href=#using-custom-label-selectors-in-prometheus class=md-nav__link> Using custom label selectors in Prometheus </a> </li> <li class=md-nav__item> <a href=#horizontal-pod-scaling-using-kubernetes-event-driven-autoscaling-keda class=md-nav__link> Horizontal Pod Scaling using Kubernetes Event-driven Autoscaling (KEDA) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ceph-nfs-crd/ class=md-nav__link> <span class=md-ellipsis> NFS CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-object-bucket-claim/ class=md-nav__link> <span class=md-ellipsis> Object Bucket Claim </span> </a> </li> <li class=md-nav__item> <a href=../ceph-object-bucket-notifications/ class=md-nav__link> <span class=md-ellipsis> Bucket Notifications </span> </a> </li> <li class=md-nav__item> <a href=../ceph-object-multisite-crd/ class=md-nav__link> <span class=md-ellipsis> Object Multisite CRDs </span> </a> </li> <li class=md-nav__item> <a href=../ceph-object-multisite/ class=md-nav__link> <span class=md-ellipsis> Object Multisite </span> </a> </li> <li class=md-nav__item> <a href=../ceph-object-store-crd/ class=md-nav__link> <span class=md-ellipsis> Object Store CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-object-store-user-crd/ class=md-nav__link> <span class=md-ellipsis> Object Store User CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-object/ class=md-nav__link> <span class=md-ellipsis> Object Storage </span> </a> </li> <li class=md-nav__item> <a href=../ceph-openshift-issues/ class=md-nav__link> <span class=md-ellipsis> OpenShift Common Issues </span> </a> </li> <li class=md-nav__item> <a href=../ceph-openshift/ class=md-nav__link> <span class=md-ellipsis> OpenShift </span> </a> </li> <li class=md-nav__item> <a href=../ceph-osd-mgmt/ class=md-nav__link> <span class=md-ellipsis> OSD Management </span> </a> </li> <li class=md-nav__item> <a href=../ceph-pool-crd/ class=md-nav__link> <span class=md-ellipsis> Block Pool CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-pool-radosnamespace/ class=md-nav__link> <span class=md-ellipsis> RADOS Namespace CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-rbd-mirror-crd/ class=md-nav__link> <span class=md-ellipsis> RBD Mirror CRD </span> </a> </li> <li class=md-nav__item> <a href=../ceph-storage/ class=md-nav__link> <span class=md-ellipsis> Ceph Storage </span> </a> </li> <li class=md-nav__item> <a href=../ceph-teardown/ class=md-nav__link> <span class=md-ellipsis> Cleanup </span> </a> </li> <li class=md-nav__item> <a href=../ceph-toolbox/ class=md-nav__link> <span class=md-ellipsis> Toolbox </span> </a> </li> <li class=md-nav__item> <a href=../ceph-tools/ class=md-nav__link> <span class=md-ellipsis> Ceph Tools </span> </a> </li> <li class=md-nav__item> <a href=../ceph-upgrade/ class=md-nav__link> <span class=md-ellipsis> Upgrades </span> </a> </li> <li class=md-nav__item> <a href=../common-issues/ class=md-nav__link> <span class=md-ellipsis> Common Issues </span> </a> </li> <li class=md-nav__item> <a href=../development-environment/ class=md-nav__link> <span class=md-ellipsis> Developer Environment </span> </a> </li> <li class=md-nav__item> <a href=../development-flow/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=../direct-tools/ class=md-nav__link> <span class=md-ellipsis> Direct Tools </span> </a> </li> <li class=md-nav__item> <a href=../helm-ceph-cluster/ class=md-nav__link> <span class=md-ellipsis> Ceph Cluster </span> </a> </li> <li class=md-nav__item> <a href=../helm-operator/ class=md-nav__link> <span class=md-ellipsis> Ceph Operator </span> </a> </li> <li class=md-nav__item> <a href=../helm/ class=md-nav__link> <span class=md-ellipsis> Helm Charts </span> </a> </li> <li class=md-nav__item> <a href=../pod-security-policies/ class=md-nav__link> <span class=md-ellipsis> Pod Security Policies </span> </a> </li> <li class=md-nav__item> <a href=../pre-reqs/ class=md-nav__link> <span class=md-ellipsis> Prerequisites </span> </a> </li> <li class=md-nav__item> <a href=../quickstart/ class=md-nav__link> <span class=md-ellipsis> Quickstart </span> </a> </li> <li class=md-nav__item> <a href=../rbd-mirroring/ class=md-nav__link> <span class=md-ellipsis> RBD Mirroring </span> </a> </li> <li class=md-nav__item> <a href=../storage-providers/ class=md-nav__link> <span class=md-ellipsis> Storage Providers </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#prometheus-operator class=md-nav__link> Prometheus Operator </a> </li> <li class=md-nav__item> <a href=#prometheus-instances class=md-nav__link> Prometheus Instances </a> </li> <li class=md-nav__item> <a href=#prometheus-web-console class=md-nav__link> Prometheus Web Console </a> </li> <li class=md-nav__item> <a href=#prometheus-consoles class=md-nav__link> Prometheus Consoles </a> </li> <li class=md-nav__item> <a href=#prometheus-alerts class=md-nav__link> Prometheus Alerts </a> <nav class=md-nav aria-label="Prometheus Alerts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#customize-alerts class=md-nav__link> Customize Alerts </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#grafana-dashboards class=md-nav__link> Grafana Dashboards </a> </li> <li class=md-nav__item> <a href=#updates-and-upgrades class=md-nav__link> Updates and Upgrades </a> </li> <li class=md-nav__item> <a href=#teardown class=md-nav__link> Teardown </a> </li> <li class=md-nav__item> <a href=#special-cases class=md-nav__link> Special Cases </a> <nav class=md-nav aria-label="Special Cases"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tectonic-bare-metal class=md-nav__link> Tectonic Bare Metal </a> </li> <li class=md-nav__item> <a href=#csi-liveness class=md-nav__link> CSI Liveness </a> </li> <li class=md-nav__item> <a href=#collecting-rbd-per-image-io-statistics class=md-nav__link> Collecting RBD per-image IO statistics </a> </li> <li class=md-nav__item> <a href=#using-custom-label-selectors-in-prometheus class=md-nav__link> Using custom label selectors in Prometheus </a> </li> <li class=md-nav__item> <a href=#horizontal-pod-scaling-using-kubernetes-event-driven-autoscaling-keda class=md-nav__link> Horizontal Pod Scaling using Kubernetes Event-driven Autoscaling (KEDA) </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/rook/rook/edit/master/Documentation/ceph-monitoring.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <p>{% include_relative branch.liquid %}</p> <h1 id=prometheus-monitoring>Prometheus Monitoring<a class=headerlink href=#prometheus-monitoring title="Permanent link">&para;</a></h1> <p>Each Rook Ceph cluster has some built in metrics collectors/exporters for monitoring with <a href=https://prometheus.io/ >Prometheus</a>.</p> <p>If you do not have Prometheus running, follow the steps below to enable monitoring of Rook. If your cluster already<br> contains a Prometheus instance, it will automatically discover Rook's scrape endpoint using the standard<br> <code>prometheus.io/scrape</code> and <code>prometheus.io/port</code> annotations.</p> <blockquote> <p><strong>NOTE</strong>: This assumes that the Prometheus instances is searching all your Kubernetes namespaces for Pods with these annotations.<br> If prometheus is already installed in a cluster, it may not be configured to watch for third-party service monitors such as for Rook.<br> Normally you should be able to add the prometheus annotations "prometheus.io/scrape=true" and prometheus.io/port={port} and<br> prometheus would automatically configure the scrape points and start gathering metrics. If prometheus isn't configured to do this, see the<br> <a href=https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack#prometheusioscrape>prometheus operator docs</a>.</p> </blockquote> <h2 id=prometheus-operator>Prometheus Operator<a class=headerlink href=#prometheus-operator title="Permanent link">&para;</a></h2> <p>First the Prometheus operator needs to be started in the cluster so it can watch for our requests to start monitoring Rook and respond by deploying the correct Prometheus pods and configuration.<br> A full explanation can be found in the <a href=https://github.com/prometheus-operator/prometheus-operator>Prometheus operator repository on GitHub</a>, but the quick instructions can be found here:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl apply -f https://raw.githubusercontent.com/coreos/prometheus-operator/v0.40.0/bundle.yaml</span>
</code></pre></div> </td></tr></table> <p>This will start the Prometheus operator, but before moving on, wait until the operator is in the <code>Running</code> state:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl get pod</span>
</code></pre></div> </td></tr></table> <p>Once the Prometheus operator is in the <code>Running</code> state, proceed to the next section to create a Prometheus instance.</p> <h2 id=prometheus-instances>Prometheus Instances<a class=headerlink href=#prometheus-instances title="Permanent link">&para;</a></h2> <p>With the Prometheus operator running, we can create a service monitor that will watch the Rook cluster and collect metrics regularly.<br> From the root of your locally cloned Rook repo, go the monitoring directory:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=gp>$ </span>git clone --single-branch --branch <span class=o>{{</span> branchName <span class=o>}}</span> https://github.com/rook/rook.git
<span class=go>cd rook/deploy/examples/monitoring</span>
</code></pre></div> </td></tr></table> <p>Create the service monitor as well as the Prometheus server pod and service:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl create -f service-monitor.yaml</span>
<span class=go>kubectl create -f prometheus.yaml</span>
<span class=go>kubectl create -f prometheus-service.yaml</span>
</code></pre></div> </td></tr></table> <p>Ensure that the Prometheus server pod gets created and advances to the <code>Running</code> state before moving on:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl -n rook-ceph get pod prometheus-rook-prometheus-0</span>
</code></pre></div> </td></tr></table> <blockquote> <p><strong>NOTE</strong>: It is not recommended to consume storage from the Ceph cluster for Prometheus.<br> If the Ceph cluster fails, Prometheus would become unresponsive and thus not alert you of the failure.</p> </blockquote> <h2 id=prometheus-web-console>Prometheus Web Console<a class=headerlink href=#prometheus-web-console title="Permanent link">&para;</a></h2> <p>Once the Prometheus server is running, you can open a web browser and go to the URL that is output from this command:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>echo &quot;http://$(kubectl -n rook-ceph -o jsonpath={.status.hostIP} get pod prometheus-rook-prometheus-0):30900&quot;</span>
</code></pre></div> </td></tr></table> <p>You should now see the Prometheus monitoring website.</p> <p><img alt="Prometheus Monitoring Website" src=../media/prometheus-monitor.png></p> <p>Click on <code>Graph</code> in the top navigation bar.</p> <p><img alt="Prometheus Add graph" src=../media/prometheus-graph.png></p> <p>In the dropdown that says <code>insert metric at cursor</code>, select any metric you would like to see, for example <code>ceph_cluster_total_used_bytes</code></p> <p><img alt="Prometheus Select Metric" src=../media/prometheus-metric-cursor.png></p> <p>Click on the <code>Execute</code> button.</p> <p><img alt="Prometheus Execute Metric" src=../media/prometheus-execute-metric-cursor.png></p> <p>Below the <code>Execute</code> button, ensure the <code>Graph</code> tab is selected and you should now see a graph of your chosen metric over time.</p> <p><img alt="Prometheus Execute Metric" src=../media/prometheus-metric-cursor-graph.png></p> <h2 id=prometheus-consoles>Prometheus Consoles<a class=headerlink href=#prometheus-consoles title="Permanent link">&para;</a></h2> <p>You can find Prometheus Consoles for and from Ceph here: <a href=https://github.com/ceph/cephmetrics/tree/master/dashboards/current>GitHub ceph/cephmetrics - dashboards/current directory</a>.</p> <p>A guide to how you can write your own Prometheus consoles can be found on the official Prometheus site here: <a href=https://prometheus.io/docs/visualization/consoles/ >Prometheus.io Documentation - Console Templates</a>.</p> <h2 id=prometheus-alerts>Prometheus Alerts<a class=headerlink href=#prometheus-alerts title="Permanent link">&para;</a></h2> <p>To enable the Ceph Prometheus alerts via the helm charts, set the following properties in values.yaml:<br> - rook-ceph chart:<br> <code>monitoring.enabled: true</code><br> - rook-ceph-cluster chart:<br> <code>monitoring.enabled: true</code><br> <code>monitoring.createPrometheusRules: true</code></p> <p>Alternatively, to enable the Ceph Prometheus alerts with example manifests follow these steps:</p> <ol> <li>Create the RBAC and prometheus rules:</li> </ol> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl create -f deploy/examples/monitoring/rbac.yaml</span>
<span class=go>kubectl create -f deploy/examples/monitoring/localrules.yaml</span>
</code></pre></div> </td></tr></table> <ol> <li>Make following changes to your CephCluster object (e.g., <code>cluster.yaml</code>).</li> </ol> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ceph.rook.io/v1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CephCluster</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class="p p-Indicator">[</span><span class=nv>...</span><span class="p p-Indicator">]</span><span class=w></span>
<span class=nt>spec</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">[</span><span class=nv>...</span><span class="p p-Indicator">]</span><span class=w></span>
<span class=w>  </span><span class=nt>monitoring</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class="p p-Indicator">[</span><span class=nv>...</span><span class="p p-Indicator">]</span><span class=w></span>
</code></pre></div> </td></tr></table> <ol> <li>Deploy or update the CephCluster object.</li> </ol> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl apply -f cluster.yaml</span>
</code></pre></div> </td></tr></table> <blockquote> <p><strong>NOTE</strong>: This expects the Prometheus Operator and a Prometheus instance to be pre-installed by the admin.</p> </blockquote> <h3 id=customize-alerts>Customize Alerts<a class=headerlink href=#customize-alerts title="Permanent link">&para;</a></h3> <p>The Prometheus alerts can be customized with a post-processor using tools such as <a href=https://kustomize.io/ >Kustomize</a>.<br> For example, first extract the helm chart:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>helm template -f values.yaml rook-release/rook-ceph-cluster &gt; cluster-chart.yaml</span>
</code></pre></div> </td></tr></table> <p>Now create the desired customization configuration files. This simple example will show how to<br> update the severity of a rule, add a label to a rule, and change the <code>for</code> time value.</p> <p>Create a file named kustomization.yaml:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>patches</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">modifications.yaml</span><span class=w></span>
<span class=w>  </span><span class=nt>target</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">monitoring.coreos.com</span><span class=w></span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PrometheusRule</span><span class=w></span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-ceph-rules</span><span class=w></span>
<span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<span class=nt>resources</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cluster-chart.yaml</span><span class=w></span>
</code></pre></div> </td></tr></table> <p>Create a file named modifications.yaml</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>op</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add</span><span class=w></span>
<span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/spec/groups/0/rules/0/labels</span><span class=w></span>
<span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>my-label</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">foo</span><span class=w></span>
<span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">none</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>op</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">add</span><span class=w></span>
<span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/spec/groups/0/rules/0/for</span><span class=w></span>
<span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">15m</span><span class=w></span>
</code></pre></div> </td></tr></table> <p>Finally, run kustomize to update the desired prometheus rules:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kustomize build . &gt; updated-chart.yaml</span>
<span class=go>kubectl create -f updated-chart.yaml</span>
</code></pre></div> </td></tr></table> <h2 id=grafana-dashboards>Grafana Dashboards<a class=headerlink href=#grafana-dashboards title="Permanent link">&para;</a></h2> <p>The dashboards have been created by <a href=https://github.com/galexrt>@galexrt</a>. For feedback on the dashboards please reach out to him on the <a href=https://slack.rook.io>Rook.io Slack</a>.</p> <blockquote> <p><strong>NOTE</strong>: The dashboards are only compatible with Grafana 7.2.0 or higher.</p> <p>Also note that the dashboards are updated from time to time, to fix issues and improve them.</p> </blockquote> <p>The following Grafana dashboards are available:</p> <ul> <li><a href=https://grafana.com/dashboards/2842>Ceph - Cluster</a></li> <li><a href=https://grafana.com/dashboards/5336>Ceph - OSD (Single)</a></li> <li><a href=https://grafana.com/dashboards/5342>Ceph - Pools</a></li> </ul> <h2 id=updates-and-upgrades>Updates and Upgrades<a class=headerlink href=#updates-and-upgrades title="Permanent link">&para;</a></h2> <p>When updating Rook, there may be updates to RBAC for monitoring. It is easy to apply the changes<br> with each update or upgrade. This should be done at the same time you update Rook common resources<br> like <code>common.yaml</code>.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl apply -f deploy/examples/monitoring/rbac.yaml</span>
</code></pre></div> </td></tr></table> <blockquote> <p>This is updated automatically if you are upgrading via the helm chart</p> </blockquote> <h2 id=teardown>Teardown<a class=headerlink href=#teardown title="Permanent link">&para;</a></h2> <p>To clean up all the artifacts created by the monitoring walk-through, copy/paste the entire block below (note that errors about resources "not found" can be ignored):</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl delete -f service-monitor.yaml</span>
<span class=go>kubectl delete -f prometheus.yaml</span>
<span class=go>kubectl delete -f prometheus-service.yaml</span>
<span class=go>kubectl delete -f https://raw.githubusercontent.com/coreos/prometheus-operator/v0.40.0/bundle.yaml</span>
</code></pre></div> </td></tr></table> <p>Then the rest of the instructions in the <a href=https://github.com/prometheus-operator/prometheus-operator#removal>Prometheus Operator docs</a> can be followed to finish cleaning up.</p> <h2 id=special-cases>Special Cases<a class=headerlink href=#special-cases title="Permanent link">&para;</a></h2> <h3 id=tectonic-bare-metal>Tectonic Bare Metal<a class=headerlink href=#tectonic-bare-metal title="Permanent link">&para;</a></h3> <p>Tectonic strongly discourages the <code>tectonic-system</code> Prometheus instance to be used outside their intentions, so you need to create a new <a href=https://coreos.com/operators/prometheus/docs/latest/ >Prometheus Operator</a> yourself.<br> After this you only need to create the service monitor as stated above.</p> <h3 id=csi-liveness>CSI Liveness<a class=headerlink href=#csi-liveness title="Permanent link">&para;</a></h3> <p>To integrate CSI liveness and grpc into ceph monitoring we will need to deploy<br> a service and service monitor.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=go>kubectl create -f csi-metrics-service-monitor.yaml</span>
</code></pre></div> </td></tr></table> <p>This will create the service monitor to have promethues monitor CSI</p> <h3 id=collecting-rbd-per-image-io-statistics>Collecting RBD per-image IO statistics<a class=headerlink href=#collecting-rbd-per-image-io-statistics title="Permanent link">&para;</a></h3> <p>RBD per-image IO statistics collection is disabled by default. This can be enabled by setting <code>enableRBDStats: true</code> in the CephBlockPool spec.<br> Prometheus does not need to be restarted after enabling it.</p> <h3 id=using-custom-label-selectors-in-prometheus>Using custom label selectors in Prometheus<a class=headerlink href=#using-custom-label-selectors-in-prometheus title="Permanent link">&para;</a></h3> <p>If Prometheus needs to select specific resources, we can do so by injecting labels into these objects and using it as label selector.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ceph.rook.io/v1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CephCluster</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">[</span><span class=nv>...</span><span class="p p-Indicator">]</span><span class=w></span>
<span class=nt>spec</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">[</span><span class=nv>...</span><span class="p p-Indicator">]</span><span class=w></span>
<span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>monitoring</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>prometheus</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">k8s</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">[</span><span class=nv>...</span><span class="p p-Indicator">]</span><span class=w></span>
</code></pre></div> </td></tr></table> <h3 id=horizontal-pod-scaling-using-kubernetes-event-driven-autoscaling-keda>Horizontal Pod Scaling using Kubernetes Event-driven Autoscaling (KEDA)<a class=headerlink href=#horizontal-pod-scaling-using-kubernetes-event-driven-autoscaling-keda title="Permanent link">&para;</a></h3> <p>Using metrics exported from the Prometheus service, the horizontal pod scaling can use the custom metrics other than CPU and memory consumption. It can be done with help of Prometheus Scaler provided by the <a href=https://keda.sh/docs/2.5/scalers/prometheus/ >KEDA</a>. See the <a href=https://keda.sh/docs/2.5/deploy/ >KEDA deployment guide</a> for details.</p> <p>Following is an example to autoscale RGW:<br> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">keda.sh/v1alpha1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ScaledObject</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rgw-scale</span><span class=w></span>
<span class=w> </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=nt>spec</span><span class=p>:</span><span class=w></span>
<span class=w> </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w></span>
<span class=w>   </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class=w></span>
<span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph-rgw-my-store-a</span><span class=w> </span><span class=c1># deployment for the autoscaling</span><span class=w></span>
<span class=w> </span><span class=nt>minReplicaCount</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class=w></span>
<span class=w> </span><span class=nt>maxReplicaCount</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class=w></span>
<span class=w> </span><span class=nt>triggers</span><span class=p>:</span><span class=w></span>
<span class=w> </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">prometheus</span><span class=w></span>
<span class=w>   </span><span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>     </span><span class=nt>serverAddress</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://rook-prometheus.rook-ceph.svc:9090</span><span class=w></span>
<span class=w>     </span><span class=nt>metricName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">collecting_ceph_rgw_put</span><span class=w></span>
<span class=w>     </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span><span class=w></span>
<span class=w>       </span><span class=no>sum(rate(ceph_rgw_put[2m])) # promethues query used for autoscaling</span><span class=w></span>
<span class=w>     </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span><span class=s>&quot;90&quot;</span><span class=w></span>
</code></pre></div> </td></tr></table></p> </article> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> </div> </div> <a href=# class="md-top md-top--hidden md-icon" data-md-component=top> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../ceph-mon-health/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Monitor Health" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Monitor Health </div> </div> </a> <a href=../ceph-nfs-crd/ class="md-footer__link md-footer__link--next" aria-label="Next: NFS CRD" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> NFS CRD </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> <a href=/ class=logo> <img src=/images/rook-logo-small.svg alt=rook.io> </a> <p> &#169; Rook Authors {{ site.time | date: '%Y' }}. Documentation distributed under <a href=https://creativecommons.org/licenses/by/4.0>CC-BY-4.0</a>. </p> <p> &#169; {{ site.time | date: '%Y' }} The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage/ >Trademark Usage</a> page. </p> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs Insiders </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.tabs.link", "instant", "navigation.expand", "navigation.top", "navigation.tracking", "privacy", "search.highlight", "search.share", "search.suggest", "tabs"], "search": "../assets/javascripts/workers/search.5c9dbbf3.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script> <script src=../assets/javascripts/bundle.10bf1588.min.js></script> </body> </html>